<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø²Ø­Ø§Ù… - Google Maps + GeoJSON</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
  <style>
    body { background: #f9f9f9; text-align: center; font-family: 'Arial'; }
    #map { width: 100%; height: 600px; max-width: 960px; margin: 20px auto; border-radius: 12px; }
    #slider { width: 260px; margin: 16px auto; }
    .card-custom { background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; margin-top: 20px; }
  </style>
</head>
<body>

  <div class="container py-4">
    <div class="card-custom">
      <h2 class="mb-4">ğŸš¦ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø²Ø­Ø§Ù… - Ø§Ù„Ø±ÙŠØ§Ø¶ (Google Maps + GeoJSON)</h2>

      <label class="form-label fw-bold">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª:</label>
      <div id="slider"></div>
      <button id="resetBtn" class="btn btn-secondary mt-3">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>

      <div id="map"></div>
    </div>
  </div>

  <script>
    let map;
    let geojsonData;
    let slider;
    let markers = [];
    const times = ['0800', '1300', '1800'];
    let currentIndex = 0;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 24.7136, lng: 46.6839 },
        zoom: 12
      });

      fetch("roads.geojson")
        .then(res => res.json())
        .then(data => {
          geojsonData = data;
          drawRoads(times[currentIndex]);

          slider = document.getElementById("slider");
          noUiSlider.create(slider, {
            start: 0,
            step: 1,
            range: { min: 0, max: times.length - 1 },
            tooltips: {
              to: value => times[value].slice(0, 2) + ":00",
              from: Number
            },
            format: {
              to: value => parseInt(value),
              from: Number
            }
          });

          slider.noUiSlider.on("update", ([value]) => {
            currentIndex = parseInt(value);
            drawRoads(times[currentIndex]);
          });

          document.getElementById("resetBtn").addEventListener("click", () => {
            slider.noUiSlider.set(0);
            currentIndex = 0;
            drawRoads(times[0]);
            map.setCenter({ lat: 24.7136, lng: 46.6839 });
            map.setZoom(12);
          });
        });
    }

    function drawRoads(timeKey) {
      map.data.forEach(f => map.data.remove(f));
      markers.forEach(m => m.setMap(null));
      markers = [];

      geojsonData.features.forEach(feature => {
        const color = feature.properties[`color${timeKey}`] || "#cccccc";
        const coords = feature.geometry.coordinates;
        const start = coords[0];
        const end = coords[coords.length - 1];

        const newFeature = {
          type: "Feature",
          geometry: feature.geometry,
          properties: {
            name: feature.properties.name,
            color,
            density: getDensityFromColor(color)
          }
        };
        map.data.addGeoJson(newFeature);

        // Add start and end markers
        const startMarker = new google.maps.Marker({
          position: { lat: start[1], lng: start[0] },
          map: map,
          label: "ğŸŸ¢",
          title: `Ø¨Ø¯Ø§ÙŠØ© ${feature.properties.name}`
        });
        const endMarker = new google.maps.Marker({
          position: { lat: end[1], lng: end[0] },
          map: map,
          label: "ğŸ”´",
          title: `Ù†Ù‡Ø§ÙŠØ© ${feature.properties.name}`
        });

        markers.push(startMarker, endMarker);
      });

      map.data.setStyle(f => ({
        strokeColor: f.getProperty("color"),
        strokeWeight: 6,
        strokeOpacity: 1,
        clickable: true,
        zIndex: 10
      }));

      map.data.addListener("click", function(event) {
        const name = event.feature.getProperty("name") || "Ø·Ø±ÙŠÙ‚";
        const color = event.feature.getProperty("color");
        const density = event.feature.getProperty("density") || "ØŸ";

        const content = `<div style='font-size:14px;'><b>${name}</b><br>Ø§Ù„ÙƒØ«Ø§ÙØ©: ${density}</div>`;
        const infowindow = new google.maps.InfoWindow({
          content,
          position: event.latLng
        });
        infowindow.open(map);
      });
    }

    function getDensityFromColor(color) {
      switch (color) {
        case "#00C853": return "Ø®ÙÙŠÙ (< 10)";
        case "#FFEB3B": return "Ù…ØªÙˆØ³Ø· (10â€“24)";
        case "#D50000": return "ÙƒØ«ÙŠÙ (25+)";
        default: return "ØŸ";
      }
    }
  </script>

  <!-- Google Maps API -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCut6dz90StDvWaO8w32A1iH7u84LD9tMM&callback=initMap">
  </script>

</body>
</html>
